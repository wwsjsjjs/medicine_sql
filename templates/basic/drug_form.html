{% extends "base.html" %}

{% block title %}{% if drug %}ç¼–è¾‘{% else %}æ·»åŠ {% endif %}è¯å“ - åŒ»è¯ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}{% if drug %}ç¼–è¾‘{% else %}æ·»åŠ {% endif %}è¯å“{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{% if drug %}ç¼–è¾‘{% else %}æ·»åŠ {% endif %}è¯å“</h2>
    {% if not drug %}
    <button type="button" onclick="quickFill('drug')" class="btn btn-success">
        ğŸ² å¿«é€Ÿå¡«å……æµ‹è¯•æ•°æ®
    </button>
    {% endif %}
</div>

<div class="table-card">
    <form method="post" onsubmit="return validateDrugForm()"
        <div class="form-row">
            <div class="form-group">
                <label for="name">è¯å“åç§° *</label>
                <input type="text" id="name" name="name" class="form-control" 
                       value="{{ drug.name if drug else '' }}" 
                       placeholder="ä¾‹å¦‚ï¼šé˜¿è«è¥¿æ—èƒ¶å›Š" required>
            </div>
            
            <div class="form-group">
                <label for="spec">è§„æ ¼</label>
                <input type="text" id="spec" name="spec" class="form-control" 
                       value="{{ drug.spec if drug else '' }}"
                       placeholder="ä¾‹å¦‚ï¼š0.25g*24ç²’">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="manufacturer">ç”Ÿäº§å‚å®¶</label>
                <input type="text" id="manufacturer" name="manufacturer" class="form-control" 
                       value="{{ drug.manufacturer if drug else '' }}"
                       placeholder="ä¾‹å¦‚ï¼šæ‰¬å­æ±Ÿè¯ä¸šé›†å›¢">
            </div>
            
            <div class="form-group">
                <label for="approval_number">æ‰¹å‡†æ–‡å·</label>
                <input type="text" id="approval_number" name="approval_number" class="form-control" 
                       value="{{ drug.approval_number if drug else '' }}"
                       placeholder="ä¾‹å¦‚ï¼šå›½è¯å‡†å­—Z20210001">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="category">ç±»åˆ«</label>
                <select id="category" name="category" class="form-control">
                    <option value="å¤„æ–¹" {% if drug and drug.category == 'å¤„æ–¹' %}selected{% endif %}>å¤„æ–¹</option>
                    <option value="éå¤„æ–¹" {% if drug and drug.category == 'éå¤„æ–¹' %}selected{% endif %}>éå¤„æ–¹</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="unit">å•ä½</label>
                <input type="text" id="unit" name="unit" class="form-control" 
                       value="{{ drug.unit if drug else '' }}" placeholder="ç›’/ç“¶/ç‰‡">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="purchase_price">è¿›è´§ä»·</label>
                <input type="number" step="0.01" id="purchase_price" name="purchase_price" class="form-control" 
                       value="{{ drug.purchase_price if drug else '' }}">
            </div>
            
            <div class="form-group">
                <label for="sale_price">é”€å”®ä»·</label>
                <input type="number" step="0.01" id="sale_price" name="sale_price" class="form-control" 
                       value="{{ drug.sale_price if drug else '' }}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="shelf_life_months">ä¿è´¨æœŸï¼ˆæœˆï¼‰</label>
                <input type="number" min="1" id="shelf_life_months" name="shelf_life_months" class="form-control"
                       value="{{ drug.shelf_life_months if drug and drug.shelf_life_months is not none else '' }}" 
                       placeholder="ä¾‹å¦‚ï¼š6 è¡¨ç¤º 6 ä¸ªæœˆ">
            </div>

            <div class="form-group">
                <label for="status">çŠ¶æ€</label>
                <select id="status" name="status" class="form-control">
                    <option value="åœ¨å”®" {% if drug and drug.status == 'åœ¨å”®' %}selected{% endif %}>åœ¨å”®</option>
                    <option value="ä¸‹æ¶" {% if drug and drug.status == 'ä¸‹æ¶' %}selected{% endif %}>ä¸‹æ¶</option>
                </select>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <a href="{{ url_for('basic.drug_list') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
function validateDrugForm() {
    const name = document.getElementById('name').value.trim();
    const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
    const salePrice = parseFloat(document.getElementById('sale_price').value) || 0;
    const approval = document.getElementById('approval_number').value.trim();
    const shelfLife = document.getElementById('shelf_life_months').value;
    
    if (!name) {
        alert('è¯·è¾“å…¥è¯å“åç§°');
        return false;
    }
    
    if (purchasePrice < 0 || salePrice < 0) {
        alert('ä»·æ ¼ä¸èƒ½ä¸ºè´Ÿæ•°');
        return false;
    }
    
    if (salePrice > 0 && purchasePrice > 0 && salePrice < purchasePrice) {
        if (!confirm('é”€å”®ä»·ä½äºè¿›è´§ä»·ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
            return false;
        }
    }
    
    // æ‰¹å‡†æ–‡å·æ ¼å¼éªŒè¯ï¼ˆå¯é€‰ï¼‰
    if (approval && !/^[å›½è¿›]è¯å‡†å­—[A-Z]\d{8}$/.test(approval)) {
        if (!confirm('æ‰¹å‡†æ–‡å·æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ˆåº”ä¸ºï¼šå›½è¯å‡†å­—Z20210001ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
            return false;
        }
    }

    if (shelfLife && Number(shelfLife) <= 0) {
        alert('ä¿è´¨æœŸå¿…é¡»ä¸ºæ­£æ•°ï¼ˆæœˆï¼‰');
        return false;
    }
    
    return true;
}
</script>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
