{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè¡¨æŸ¥çœ‹ - åŒ»è¯ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}ç³»ç»Ÿè¡¨æ•°æ®{% endblock %}

{% block content %}
<div class="system-tables-page">
    <div class="page-header">
        <h2>ç³»ç»ŸåŸºç¡€è¡¨æ•°æ®æŸ¥çœ‹</h2>
        <button class="btn btn-primary" onclick="loadSystemTables()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    </div>

    <!-- è§’è‰²è¡¨ -->
    <div class="table-section">
        <h3>ğŸ‘¥ è§’è‰²è¡¨ (Role)</h3>
        <div id="roles-table" class="data-display"></div>
    </div>

    <!-- æƒé™è¡¨ -->
    <div class="table-section">
        <h3>ğŸ” æƒé™è¡¨ (Permission)</h3>
        <div id="permissions-table" class="data-display"></div>
    </div>

    <!-- è§’è‰²æƒé™å…³è”è¡¨ -->
    <div class="table-section">
        <h3>ğŸ”— è§’è‰²æƒé™å…³è”è¡¨ (RolePermission)</h3>
        <div id="role-permissions-table" class="data-display"></div>
    </div>

    <!-- ç”¨æˆ·è§’è‰²å…³è”è¡¨ -->
    <div class="table-section">
        <h3>ğŸ‘¤ ç”¨æˆ·è§’è‰²å…³è”è¡¨ (UserRole)</h3>
        <div id="user-roles-table" class="data-display"></div>
    </div>

    <!-- ç³»ç»Ÿæ—¥å¿—è¡¨ -->
    <div class="table-section">
        <h3>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—è¡¨ (SystemLog) - æœ€è¿‘50æ¡</h3>
        <div id="logs-table" class="data-display"></div>
    </div>
</div>

<style>
.system-tables-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.table-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.table-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2d3748;
    border-bottom: 2px solid #f97316;
    padding-bottom: 10px;
}

.data-display {
    overflow-x: auto;
}

.data-display table {
    width: 100%;
    border-collapse: collapse;
}

.data-display th {
    background: #f7fafc;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    font-weight: 600;
    color: #2d3748;
}

.data-display td {
    padding: 10px 12px;
    border-bottom: 1px solid #e2e8f0;
}

.data-display tr:hover {
    background: #f7fafc;
}

.empty-message {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #4299e1;
}
</style>

<script>
function loadSystemTables() {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.querySelectorAll('.data-display').forEach(el => {
        el.innerHTML = '<div class="loading">â³ åŠ è½½ä¸­...</div>';
    });

    fetch('/api/test/system_tables')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRoles(data.data.roles);
                displayPermissions(data.data.permissions);
                displayRolePermissions(data.data.role_permissions);
                displayUserRoles(data.data.user_roles);
                displayLogs(data.data.logs);
            } else {
                alert('åŠ è½½å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åŠ è½½ç³»ç»Ÿè¡¨æ•°æ®å¤±è´¥');
        });
}

function displayRoles(roles) {
    const container = document.getElementById('roles-table');
    if (!roles || roles.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— è§’è‰²æ•°æ®</div>';
        return;
    }
    
    let html = '<table><thead><tr><th>è§’è‰²ID</th><th>è§’è‰²åç§°</th><th>æè¿°</th></tr></thead><tbody>';
    roles.forEach(role => {
        html += `<tr><td>${role.id}</td><td>${role.name}</td><td>${role.description || '-'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayPermissions(permissions) {
    const container = document.getElementById('permissions-table');
    if (!permissions || permissions.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— æƒé™æ•°æ®</div>';
        return;
    }
    
    let html = '<table><thead><tr><th>æƒé™ID</th><th>æƒé™åç§°</th><th>æè¿°</th></tr></thead><tbody>';
    permissions.forEach(perm => {
        html += `<tr><td>${perm.id}</td><td>${perm.name}</td><td>${perm.description || '-'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayRolePermissions(rolePerms) {
    const container = document.getElementById('role-permissions-table');
    if (!rolePerms || rolePerms.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— è§’è‰²æƒé™å…³è”æ•°æ®</div>';
        return;
    }
    
    let html = '<table><thead><tr><th>è§’è‰²</th><th>æƒé™</th></tr></thead><tbody>';
    rolePerms.forEach(rp => {
        html += `<tr><td>${rp.role}</td><td>${rp.permission}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayUserRoles(userRoles) {
    const container = document.getElementById('user-roles-table');
    if (!userRoles || userRoles.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— ç”¨æˆ·è§’è‰²å…³è”æ•°æ®</div>';
        return;
    }
    
    let html = '<table><thead><tr><th>å‘˜å·¥</th><th>è§’è‰²</th></tr></thead><tbody>';
    userRoles.forEach(ur => {
        html += `<tr><td>${ur.employee}</td><td>${ur.role}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

function displayLogs(logs) {
    const container = document.getElementById('logs-table');
    if (!logs || logs.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— ç³»ç»Ÿæ—¥å¿—æ•°æ®</div>';
        return;
    }
    
    let html = '<table><thead><tr><th>æ—¥å¿—ID</th><th>å‘˜å·¥ID</th><th>æ“ä½œç±»å‹</th><th>è¡¨å</th><th>æ“ä½œæ—¶é—´</th></tr></thead><tbody>';
    logs.forEach(log => {
        html += `<tr><td>${log.id}</td><td>${log.employee_id || '-'}</td><td>${log.action_type}</td><td>${log.table}</td><td>${log.time}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    loadSystemTables();
});
</script>
{% endblock %}
