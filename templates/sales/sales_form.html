{% extends "base.html" %}

{% block title %}æ·»åŠ é”€å”® - åŒ»è¯ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}æ·»åŠ é”€å”®{% endblock %}

{% block content %}
<div class="page-header">
    <h2>é”€å”®ç™»è®°</h2>
    <button type="button" onclick="quickFill('sales')" class="btn btn-success">
        ğŸ² å¿«é€Ÿå¡«å……æµ‹è¯•æ•°æ®
    </button>
</div>

<div class="table-card">
    <form method="post" onsubmit="return handleSalesSubmit(event)">
        <div class="form-row">
            <div class="form-group">
                <label for="drug_id">è¯å“ *</label>
                <select id="drug_id" name="drug_id" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©è¯å“</option>
                    {% for drug in drugs %}
                    <option value="{{ drug.drug_id }}" data-price="{{ drug.sale_price }}">
                        {{ drug.name }} - Â¥{{ "%.2f"|format(drug.sale_price) }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="customer_id">å®¢æˆ· *</label>
                <select id="customer_id" name="customer_id" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                    {% for customer in customers %}
                    <option value="{{ customer.customer_id }}">{{ customer.name }} ({{ customer.type }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="quantity">æ•°é‡ *</label>
                <input type="number" id="quantity" name="quantity" class="form-control" required min="1" value="1"
                       placeholder="ä¾‹å¦‚ï¼š10">
            </div>
            
            <div class="form-group">
                <label for="unit_price">å•ä»· *</label>
                <input type="number" step="0.01" id="unit_price" name="unit_price" class="form-control" required min="0" readonly>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="sales_date">é”€å”®æ—¥æœŸ *</label>
                <input type="date" id="sales_date" name="sales_date" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>æ€»ä»·</label>
                <input type="text" id="total_display" class="form-control" readonly>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">æäº¤é”€å”®</button>
            <a href="{{ url_for('sales.sales_list') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// è‡ªåŠ¨å¡«å……å•ä»·
document.getElementById('drug_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    document.getElementById('unit_price').value = price || '';
    calculateTotal();
});

// è®¡ç®—æ€»ä»·
function calculateTotal() {
    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
    const unitPrice = parseFloat(document.getElementById('unit_price').value) || 0;
    const total = quantity * unitPrice;
    document.getElementById('total_display').value = 'Â¥' + total.toFixed(2);
}

document.getElementById('quantity').addEventListener('input', calculateTotal);
document.getElementById('unit_price').addEventListener('input', calculateTotal);

// è¡¨å•æäº¤å¤„ç†
function handleSalesSubmit(event) {
    event.preventDefault();
    
    const drugId = document.getElementById('drug_id').value;
    const customerId = document.getElementById('customer_id').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const unitPrice = parseFloat(document.getElementById('unit_price').value);
    
    // å‰ç«¯éªŒè¯
    if (!drugId) {
        alert('âŒ è¯·é€‰æ‹©è¯å“');
        return false;
    }
    
    if (!customerId) {
        alert('âŒ è¯·é€‰æ‹©å®¢æˆ·');
        return false;
    }
    
    if (quantity <= 0) {
        alert('âŒ é”€å”®æ•°é‡å¿…é¡»å¤§äº0');
        return false;
    }
    
    if (unitPrice <= 0) {
        alert('âŒ é”€å”®å•ä»·å¿…é¡»å¤§äº0');
        return false;
    }
    
    // æäº¤è¡¨å•
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'æäº¤ä¸­...';
    
    // ä½¿ç”¨åŸç”Ÿè¡¨å•æäº¤
    form.submit();
    
    // å¦‚æœ3ç§’åè¿˜æ²¡è·³è½¬ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }, 3000);
    
    return false;
}

// è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
document.getElementById('sales_date').valueAsDate = new Date();
</script>
{% endblock %}
