{% extends "base.html" %}

{% block title %}财务统计 - 医药管理系统{% endblock %}
{% block page_title %}财务统计{% endblock %}

{% block content %}
<div class="page-header">
    <h2>财务统计列表</h2>
    <button class="btn btn-primary" onclick="document.getElementById('generateModal').style.display='block'">
        ➕ 生成统计
    </button>
</div>

<div class="table-card">
    <table class="data-table">
        <thead>
            <tr>
                <th>统计ID</th>
                <th>统计类型</th>
                <th>统计日期</th>
                <th>销售总额</th>
                <th>成本总额</th>
                <th>利润总额</th>
                <th>利润率</th>
                <th>经办人</th>
                <th>创建时间</th>
            </tr>
        </thead>
        <tbody>
            {% for stat, employee_name in stats %}
            <tr>
                <td>{{ stat.stat_id }}</td>
                <td>
                    <span class="badge {% if stat.stat_type == '日' %}badge-success{% else %}badge-primary{% endif %}">
                        {{ stat.stat_type }}报
                    </span>
                </td>
                <td>{{ stat.stat_date }}</td>
                <td><strong>¥{{ "%.2f"|format(stat.total_sales) }}</strong></td>
                <td>¥{{ "%.2f"|format(stat.total_cost) }}</td>
                <td class="text-success"><strong>¥{{ "%.2f"|format(stat.total_profit) }}</strong></td>
                <td>{{ "%.1f"|format((stat.total_profit / stat.total_sales * 100) if stat.total_sales > 0 else 0) }}%</td>
                <td>{{ employee_name }}</td>
                <td>{{ stat.create_time.strftime('%Y-%m-%d %H:%M') if stat.create_time else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 生成统计模态框 -->
<div id="generateModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div style="background:white; width:500px; margin:100px auto; padding:30px; border-radius:12px;">
        <h3>生成财务统计</h3>
        <form method="post" action="{{ url_for('sales.finance_generate') }}">
            <div class="form-group">
                <label for="stat_type">统计类型</label>
                <select id="stat_type" name="stat_type" class="form-control" required>
                    <option value="日">日报</option>
                    <option value="月">月报</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="stat_date">统计日期</label>
                <input type="date" id="stat_date" name="stat_date" class="form-control" required>
            </div>
            
            <input type="hidden" name="employee_id" value="1">
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">生成统计</button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('generateModal').style.display='none'">取消</button>
            </div>
        </form>
    </div>
</div>

<style>
.text-success {
    color: #38a169;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 设置默认日期为今天
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('stat_date');
    if (dateInput) {
        dateInput.value = today;
    }
});
</script>
{% endblock %}
