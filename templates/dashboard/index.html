{% extends "base.html" %}

{% block title %}æ•°æ®ä»ªè¡¨ç›˜ - åŒ»è¯ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}æ•°æ®ä»ªè¡¨ç›˜{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-content">
                <div class="stat-label">ä»Šæ—¥é”€å”®é¢</div>
                <div class="stat-value">Â¥{{ "%.2f"|format(today_sales) }}</div>
            </div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <div class="stat-label">æœ¬æœˆé”€å”®é¢</div>
                <div class="stat-value">Â¥{{ "%.2f"|format(month_sales) }}</div>
            </div>
        </div>
        
        <div class="stat-card purple">
            <div class="stat-icon">ğŸ“¦</div>
            <div class="stat-content">
                <div class="stat-label">åº“å­˜æ€»æ•°</div>
                <div class="stat-value">{{ total_inventory }}</div>
            </div>
        </div>
        
        <div class="stat-card orange">
            <div class="stat-icon">âš ï¸</div>
            <div class="stat-content">
                <div class="stat-label">ä½åº“å­˜é¢„è­¦</div>
                <div class="stat-value">{{ low_stock_count }}</div>
            </div>
        </div>
        
        <div class="stat-card cyan">
            <div class="stat-icon">ğŸ’Š</div>
            <div class="stat-content">
                <div class="stat-label">è¯å“æ€»æ•°</div>
                <div class="stat-value">{{ total_drugs }}</div>
            </div>
        </div>
    </div>
    
    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>è¿‘7å¤©é”€å”®è¶‹åŠ¿</h3>
            <canvas id="salesTrendChart"></canvas>
        </div>
        
        <div class="chart-card">
            <h3>çƒ­é”€è¯å“ TOP 5</h3>
            <canvas id="topDrugsChart"></canvas>
        </div>
    </div>
    
    <!-- ä½åº“å­˜é¢„è­¦è¡¨ -->
    <div class="table-card">
        <h3>åº“å­˜é¢„è­¦ (åº“å­˜ < 100)</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>è¯å“åç§°</th>
                    <th>å½“å‰åº“å­˜</th>
                    <th>å•ä½</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                {% for inventory, drug_name, unit in low_stock_items %}
                <tr>
                    <td>{{ drug_name }}</td>
                    <td class="{% if inventory.quantity < 50 %}text-danger{% else %}text-warning{% endif %}">
                        {{ inventory.quantity }}
                    </td>
                    <td>{{ unit }}</td>
                    <td>
                        {% if inventory.quantity < 50 %}
                            <span class="badge badge-danger">ä¸¥é‡ä¸è¶³</span>
                        {% else %}
                            <span class="badge badge-warning">åº“å­˜è¾ƒä½</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é”€å”®è¶‹åŠ¿å›¾è¡¨
const salesData = {
    labels: [{% for sale in daily_sales %}'{{ sale[0] }}',{% endfor %}],
    datasets: [{
        label: 'é”€å”®é¢',
        data: [{% for sale in daily_sales %}{{ sale[1] }},{% endfor %}],
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.4,
        fill: true
    }]
};

new Chart(document.getElementById('salesTrendChart'), {
    type: 'line',
    data: salesData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'Â¥' + value;
                    }
                }
            }
        }
    }
});

// çƒ­é”€è¯å“å›¾è¡¨
const topDrugsData = {
    labels: [{% for drug in top_drugs %}'{{ drug[0] }}',{% endfor %}],
    datasets: [{
        label: 'é”€å”®é¢',
        data: [{% for drug in top_drugs %}{{ drug[2] }},{% endfor %}],
        backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)'
        ]
    }]
};

new Chart(document.getElementById('topDrugsChart'), {
    type: 'bar',
    data: topDrugsData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'Â¥' + value;
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
