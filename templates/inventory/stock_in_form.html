{% extends "base.html" %}

{% block title %}æ·»åŠ å…¥åº“ - åŒ»è¯ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block page_title %}æ·»åŠ å…¥åº“{% endblock %}

{% block content %}
<div class="page-header">
    <h2>å…¥åº“ç™»è®°</h2>
    <button type="button" onclick="quickFill('stock_in')" class="btn btn-success">
        ğŸ² å¿«é€Ÿå¡«å……æµ‹è¯•æ•°æ®
    </button>
</div>

<div class="table-card">
    <form method="post" onsubmit="return handleFormSubmit(event, 'validateStockInForm')">
        <div class="form-row">
            <div class="form-group">
                <label for="drug_id">è¯å“ *</label>
                <select id="drug_id" name="drug_id" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©è¯å“</option>
                    {% for drug in drugs %}
                    <option value="{{ drug.drug_id }}">{{ drug.name }} - {{ drug.spec }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="supplier_id">ä¾›åº”å•† *</label>
                <select id="supplier_id" name="supplier_id" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.supplier_id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="quantity">æ•°é‡ *</label>
                <input type="number" id="quantity" name="quantity" class="form-control" required min="1"
                       placeholder="ä¾‹å¦‚ï¼š100">
            </div>
            
            <div class="form-group">
                <label for="unit_price">å•ä»· *</label>
                <input type="number" step="0.01" id="unit_price" name="unit_price" class="form-control" required min="0"
                       placeholder="ä¾‹å¦‚ï¼š25.50">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="stock_in_date">å…¥åº“æ—¥æœŸ *</label>
                <input type="date" id="stock_in_date" name="stock_in_date" class="form-control" required 
                       value="{{ today }}">
            </div>
            
            <div class="form-group">
                <label for="warehouse_id">å…¥åº“ä»“åº“ *</label>
                <select id="warehouse_id" name="warehouse_id" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©ä»“åº“</option>
                    {% for warehouse in warehouses %}
                    <option value="{{ warehouse.warehouse_id }}">{{ warehouse.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="location">åº“ä½/è´§ä½</label>
                <input type="text" id="location" name="location" class="form-control"
                       placeholder="ä¾‹å¦‚ï¼šAåŒº-3æ’-2å±‚">
            </div>

            <div class="form-group">
                <label for="remark">å¤‡æ³¨</label>
                <textarea id="remark" name="remark" class="form-control" rows="3"
                          placeholder="ä¾‹å¦‚ï¼šç´§æ€¥è¡¥è´§ã€æ–°å“å…¥åº“ç­‰"></textarea>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">æäº¤å…¥åº“</button>
            <a href="{{ url_for('inventory.stock_in_list') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
function validateStockInForm() {
    const drugId = document.getElementById('drug_id').value;
    const supplierId = document.getElementById('supplier_id').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const unitPrice = parseFloat(document.getElementById('unit_price').value);
    const warehouseId = document.getElementById('warehouse_id').value;
    
    if (!drugId) {
        alert('âŒ è¯·é€‰æ‹©è¯å“');
        return false;
    }
    
    if (!supplierId) {
        alert('âŒ è¯·é€‰æ‹©ä¾›åº”å•†ï¼Œå¦‚æœæ²¡æœ‰ä¾›åº”å•†è¯·å…ˆæ·»åŠ ');
        return false;
    }
    
    if (!warehouseId) {
        alert('âŒ è¯·é€‰æ‹©ä»“åº“ï¼Œå¦‚æœæ²¡æœ‰ä»“åº“è¯·å…ˆæ·»åŠ ');
        return false;
    }
    
    if (quantity <= 0) {
        alert('âŒ å…¥åº“æ•°é‡å¿…é¡»å¤§äº0');
        return false;
    }
    
    if (unitPrice <= 0) {
        alert('âŒ å•ä»·å¿…é¡»å¤§äº0');
        return false;
    }
    
    return true;
}

// é€šç”¨è¡¨å•æäº¤å¤„ç†
function handleFormSubmit(event, validateFunc) {
    event.preventDefault();
    
    // æ‰§è¡ŒéªŒè¯
    if (window[validateFunc] && !window[validateFunc]()) {
        return false;
    }
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'æäº¤ä¸­...';
    
    form.submit();
    
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }, 3000);
    
    return false;
    
    if (!warehouseId) {
        alert('è¯·é€‰æ‹©ä»“åº“');
        return false;
    }
    
    if (quantity <= 0) {
        alert('å…¥åº“æ•°é‡å¿…é¡»å¤§äº0');
        return false;
    }
    
    if (unitPrice < 0) {
        alert('å•ä»·ä¸èƒ½ä¸ºè´Ÿæ•°');
        return false;
    }
    
    return true;
}
</script>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
