# 医药管理系统 - 项目指南

## 📋 目录
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [功能清单](#功能清单)
- [API接口文档](#api接口文档)
- [使用说明](#使用说明)
- [性能优化](#性能优化)
- [部署指南](#部署指南)

---

## 🛠 技术栈

### 后端技术
- **Python 3.11+**
- **Flask 3.1.2** - Web框架
- **SQLAlchemy 2.0.43** - ORM数据库映射
- **SQLite** - 数据库（可替换为MySQL/PostgreSQL）

### 前端技术
- **Jinja2** - 模板引擎
- **HTML5 + CSS3** - 页面结构和样式
- **JavaScript (ES6+)** - 交互逻辑
- **Chart.js 3.9.1** - 数据可视化

### 开发工具
- **Flask-SQLAlchemy** - 数据库集成
- **Gunicorn** - 生产环境WSGI服务器（推荐）

---

## 📁 项目结构

```
medicine_sql/
├── app.py                      # 应用入口
├── config.py                   # 配置文件
├── gunicorn_config.py          # Gunicorn配置
├── models.py                   # 数据库模型（17个表）
├── init_data.py                # 测试数据初始化脚本
├── routes/                     # 路由模块
│   ├── dashboard.py            # 仪表盘路由
│   ├── basic_info.py           # 基础信息管理
│   ├── inventory_mgmt.py       # 库存管理
│   ├── sales_mgmt.py           # 销售管理
│   └── api_test.py             # API测试接口
├── templates/                  # HTML模板
│   ├── base.html               # 基础模板
│   ├── dashboard/              # 仪表盘页面
│   ├── basic/                  # 基础信息页面
│   ├── inventory/              # 库存管理页面
│   ├── sales/                  # 销售管理页面
│   └── testing/                # 测试控制台页面
├── static/                     # 静态资源
│   ├── css/
│   │   └── style.css           # 全局样式（~600行）
│   └── js/
│       └── test_data.js        # 测试数据生成器
├── instance/
│   └── medicine.db             # SQLite数据库文件
├── 数据库设计.md                # 数据库设计文档
├── 分工.md                      # 项目分工文档
└── README.md                   # 项目说明
```

---

## ✅ 功能清单

### 1. 数据仪表盘
- [x] 实时销售趋势图表（Chart.js）
- [x] 库存状态饼图
- [x] 热销药品排行榜
- [x] 关键指标卡片展示

### 2. 基础信息管理
#### 药品管理
- [x] 药品列表（分页）
- [x] 添加/编辑/删除药品
- [x] 药品信息：名称、规格、厂家、批准文号、价格等
- [x] 表单验证：价格、批准文号格式
- [x] 快速填充测试数据

#### 员工管理
- [x] 员工列表
- [x] 添加/编辑/删除员工
- [x] 员工信息：姓名、部门、职位、电话、账号等
- [x] 手机号格式验证
- [x] 账号格式验证（字母开头，3-20位）

#### 客户管理
- [x] 客户列表
- [x] 添加/编辑/删除客户
- [x] 客户信息：名称、类型（零售/批发）、联系人、电话、地址
- [x] 电话号码验证

#### 供应商管理
- [x] 供应商列表
- [x] 添加/编辑/删除供应商
- [x] 供应商信息：名称、联系人、电话、地址、资质编号

### 3. 库存管理
#### 入库管理
- [x] 入库登记（选择药品、供应商、仓库）
- [x] 自动更新库存数量
- [x] 入库记录查询
- [x] 入库金额自动计算
- [x] 表单验证：数量、单价

#### 库存查询
- [x] 多维度库存查询（药品、仓库）
- [x] 库存预警功能
- [x] 库存统计报表

#### 仓库管理
- [x] 仓库列表
- [x] 添加/编辑/删除仓库
- [x] 仓库容量管理

#### 库存盘点
- [x] 盘点记录管理
- [x] 盈亏统计

#### 退货处理
- [x] 退货登记
- [x] 自动调整库存

### 4. 销售管理
#### 销售登记
- [x] 销售记录创建
- [x] 自动扣减库存
- [x] 库存不足提醒
- [x] 销售金额自动计算
- [x] 表单验证：客户、药品、数量

#### 销售退货
- [x] 退货登记
- [x] 自动恢复库存

#### 财务统计
- [x] 日/周/月财务报表
- [x] 收入支出统计
- [x] 利润分析

#### 销售报表
- [x] 周销售报表
- [x] 热销药品分析
- [x] 客户销售排行

### 5. API测试系统
- [x] 测试数据生成（药品、客户）
- [x] 批量入库测试
- [x] 批量销售测试
- [x] 全链路自动化测试
- [x] 系统统计实时监控
- [x] 测试日志记录

### 6. UI/UX特性
- [x] 响应式设计
- [x] 渐变色主题
- [x] 按钮悬停动画
- [x] 波浪背景动画
- [x] Flash消息提示
- [x] 表单占位符提示
- [x] 快速填充测试数据按钮
- [x] 实时表单验证

---

## 🔌 API接口文档

### 测试API接口

#### 1. 获取系统统计
```http
GET /api/test/stats
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "drugs": 15,
    "customers": 8,
    "suppliers": 5,
    "total_inventory": 2350
  }
}
```

#### 2. 生成测试药品
```http
POST /api/test/generate_drug
Content-Type: application/json

{
  "count": 10
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "成功生成 10 条药品数据",
  "data": ["阿莫西林胶囊_测试1", "头孢克肟片_测试2", ...]
}
```

#### 3. 生成测试客户
```http
POST /api/test/generate_customer
Content-Type: application/json

{
  "count": 5
}
```

#### 4. 批量入库测试
```http
POST /api/test/batch_stock_in
Content-Type: application/json

{
  "count": 100
}
```

**说明：** 创建指定数量的入库记录，自动更新库存

#### 5. 批量销售测试
```http
POST /api/test/batch_sales
Content-Type: application/json

{
  "count": 50
}
```

**说明：** 创建指定数量的销售记录，自动扣减库存

#### 6. 全链路测试
```http
POST /api/test/full_chain_test
Content-Type: application/json

{}
```

**响应示例：**
```json
{
  "success": true,
  "message": "全链路测试完成",
  "steps": [
    "✓ 创建药品: 全链路测试药品_143052",
    "✓ 使用供应商: 华康医药有限公司",
    "✓ 使用仓库: 主仓库",
    "✓ 入库成功: 100 盒",
    "✓ 使用客户: 华康医院",
    "✓ 销售成功: 10 盒，剩余库存: 90"
  ],
  "data": {
    "drug_id": 23,
    "drug_name": "全链路测试药品_143052",
    "initial_stock": 100,
    "sold": 10,
    "remaining": 90
  }
}
```

### 仪表盘API接口

#### 1. 销售趋势数据
```http
GET /api/sales_trend
```

**响应：** 返回最近7天的销售数据

#### 2. 库存状态数据
```http
GET /api/inventory_status
```

**响应：** 返回库存充足、偏低、缺货的药品数量

#### 3. 热销药品数据
```http
GET /api/top_drugs
```

**响应：** 返回销量前5的药品

---

## 📖 使用说明

### 环境准备
1. **Python环境：** Python 3.11+
2. **依赖安装：**
   ```bash
   pip install flask flask-sqlalchemy
   ```

### 启动应用

#### 开发模式
```bash
# 进入项目目录
cd d:\zlearning\project\dataset_sql\medicine_sql

# 激活conda环境
conda activate myblog

# 运行应用
python app.py
```

访问：http://127.0.0.1:5000

#### 初始化测试数据
```bash
python init_data.py
```

### 主要操作流程

#### 1. 药品入库流程
1. 访问"基础信息管理" → "药品管理" → 添加药品
2. 访问"基础信息管理" → "供应商管理" → 添加供应商
3. 访问"库存管理" → "仓库管理" → 添加仓库（如已有可跳过）
4. 访问"库存管理" → "入库登记" → 创建入库记录
5. 系统自动更新库存表

#### 2. 销售流程
1. 访问"基础信息管理" → "客户管理" → 添加客户
2. 访问"销售管理" → "销售登记" → 创建销售记录
3. 系统自动扣减库存
4. 若库存不足，系统提示错误

#### 3. 测试流程
1. 访问"系统测试" → "API测试控制台"
2. 点击"开始全链路测试"按钮
3. 系统自动执行：创建药品 → 入库 → 销售 → 更新库存
4. 查看测试日志和结果

### 表单快速填充
- 在添加表单页面（药品、员工、客户、供应商）点击 "🎲 快速填充测试数据" 按钮
- 系统自动填充随机测试数据
- 可手动修改后提交

---

## ⚡ 性能优化

### 1. 资源限制配置
在 `config.py` 中已配置：
- 最大请求体：16MB
- 会话超时：1小时

### 2. 数据库优化建议
```python
# 添加索引（在models.py中）
class DrugInfo(db.Model):
    __tablename__ = 'drug_info'
    __table_args__ = (
        db.Index('idx_drug_name', 'name'),
        db.Index('idx_drug_status', 'status'),
    )
```

### 3. 查询优化
```python
# 使用分页
drugs = DrugInfo.query.paginate(page=1, per_page=20)

# 选择性加载字段
drugs = db.session.query(DrugInfo.drug_id, DrugInfo.name).all()
```

### 4. 前端优化
- 静态资源CDN加速（Chart.js已使用CDN）
- LocalStorage缓存常用数据
- 延迟加载图片

---

## 🚀 部署指南

### 生产环境部署

#### 方式1：使用 Gunicorn（推荐）

1. **安装Gunicorn**
```bash
pip install gunicorn
```

2. **使用配置文件启动**
```bash
gunicorn -c gunicorn_config.py app:app
```

3. **直接命令启动**
```bash
gunicorn -w 4 -b 0.0.0.0:5000 --timeout 120 app:app
```

参数说明：
- `-w 4`：启动4个worker进程
- `-b 0.0.0.0:5000`：绑定地址和端口
- `--timeout 120`：请求超时120秒

#### 方式2：使用 Nginx + Gunicorn

**Nginx配置示例：**
```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /static {
        alias /path/to/medicine_sql/static;
        expires 30d;
    }

    # 请求限流
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req zone=api_limit burst=20;
}
```

#### 方式3：使用 Docker

**Dockerfile示例：**
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 5000

CMD ["gunicorn", "-c", "gunicorn_config.py", "app:app"]
```

**docker-compose.yml示例：**
```yaml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./instance:/app/instance
    environment:
      - FLASK_ENV=production
```

### 数据库迁移（SQLite → MySQL）

1. **安装MySQL驱动**
```bash
pip install pymysql
```

2. **修改config.py**
```python
SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://user:password@localhost/medicine_db'
```

3. **导出数据**
```bash
sqlite3 instance/medicine.db .dump > backup.sql
```

4. **导入MySQL**（需转换SQL语法）

### 性能测试

使用 Apache Bench 测试：
```bash
# 100个请求，10个并发
ab -n 100 -c 10 http://127.0.0.1:5000/

# 压力测试
ab -n 1000 -c 50 http://127.0.0.1:5000/
```

---

## 🔐 安全建议

1. **修改SECRET_KEY**
   ```python
   # config.py
   SECRET_KEY = os.urandom(24).hex()
   ```

2. **启用HTTPS**
   - 使用Let's Encrypt免费证书
   - 配置Nginx SSL

3. **SQL注入防护**
   - 使用SQLAlchemy参数化查询（已实现）

4. **XSS防护**
   - Jinja2自动转义（已启用）

5. **CSRF防护**
   - 可集成Flask-WTF

---

## 📝 开发规范

### 代码风格
- 遵循PEP 8规范
- 使用4空格缩进
- 函数和变量使用snake_case
- 类使用PascalCase

### 提交规范
```
feat: 新增XXX功能
fix: 修复XXX问题
docs: 更新文档
style: 代码格式调整
refactor: 代码重构
test: 测试相关
```

---

## 📞 支持与反馈

- 详细文档：查看 `数据库设计.md` 和 `分工.md`
- 问题反馈：查看项目Issues
- 技术栈文档：
  - [Flask官方文档](https://flask.palletsprojects.com/)
  - [SQLAlchemy文档](https://www.sqlalchemy.org/)
  - [Chart.js文档](https://www.chartjs.org/)

---

## 📄 许可证

本项目仅供学习和研究使用。
